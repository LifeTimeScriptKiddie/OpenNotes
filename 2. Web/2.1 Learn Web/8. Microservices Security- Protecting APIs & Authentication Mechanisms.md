## **1. Introduction to Microservices Security**

Microservices rely on APIs for communication, making **authentication & authorization** critical. Attackers often target **API tokens, JWTs, OAuth flows, and service-to-service authentication** to gain unauthorized access.

### **Key Security Concerns**

| **Security Area**               | **Common Risks**                                      | **Mitigation Strategies**                                              |
| ------------------------------- | ----------------------------------------------------- | ---------------------------------------------------------------------- |
| **Authentication & Tokens**     | API token theft, session fixation, token manipulation | Enforce **short-lived tokens, MFA, OAuth best practices**              |
| **Service-to-Service Security** | Microservices pivoting, service spoofing              | Use **mTLS, API gateways, IAM policies**                               |
| **Data Exposure**               | Over-fetching, leaking PII via APIs                   | Implement **schema validation, access controls**                       |
| **Rate-Limiting & Abuse**       | API brute force, DoS attacks                          | Configure **rate limits, WAFs, logging, and monitoring**               |
| **Session Management**          | Session hijacking, predictable session IDs            | Secure **cookie attributes, session timeouts, and replay protections** |

---

## **2. API Authentication & Token Attacks**

**APIs require secure authentication methods** to prevent **token theft, replay attacks, and session fixation.**

### **2.1 API Token Security**

|**Attack**|**Description**|**Prevention Strategies**|
|---|---|---|
|**Token Lifetime Misuse**|Long-lived tokens can be reused by attackers|Use **short-lived tokens & refresh tokens**|
|**Token in URL**|Tokens in URLs can be logged & exposed|Use **headers instead of query parameters**|
|**Session Fixation**|Attackers force victims to reuse attackerâ€™s session|Regenerate **session tokens upon authentication**|

#### **Example 1: ASCII Decoding a SESSIONID**

Attackers may analyze session tokens stored in cookies.

```bash
echo -n 757365723A6874623B726F6C653A75736572 | xxd -r -p; echo
```

---

### **2.2 OAuth & JWT Attacks**


OAuth and JWTs are widely used for API authentication, but **misconfigurations** can lead to privilege escalation.

[8a. JWT](<8a. JWT.md>) : Token-based authentication (JSON - OAuth 2.0/OpenID)
[8b. OAuth](<8b. OAuth.md>):   Authorization protocol (web and mobile)
[8c. SAML](<8c. SAML.md>): Protocol for exchanging authentication and Authorization between parties (XML)




|**Attack**|**Description**|**Mitigation**|
|---|---|---|
|**OAuth Token Reuse**|Attackers intercept & reuse OAuth tokens|Use **PKCE, refresh token rotation**|
|**JWT Manipulation**|Weak JWT signing allows token forgery|Use **strong HMAC/ECDSA algorithms & key rotation**|
|**Token Algorithm Confusion**|Changing JWT alg to `none` bypasses verification|Validate **algorithms & enforce strong signing**|


#### **Example 2: Decoding JWT**

```bash
echo 'eyJhbGciOiJub25lIn0.eyJ1c2VyIjoiYWRtaW4ifQ.' | base64 -d
```

---

## **3. Weak Session Management**

Many applications use **predictable session tokens** that can be brute-forced or manipulated.

|**Attack**|**Description**|**Prevention**|
|---|---|---|
|**Predictable Session IDs**|Weak session tokens can be guessed/brute-forced|Use **secure random token generation**|
|**Reused Session Tokens**|Different users receive identical tokens|Implement **unique tokens per session**|
|**Weak Encryption**|Attackers decode tokens via known file signatures|Use **strong hashing (bcrypt, PBKDF2, Argon2)**|

#### **Example 3: Identifying Weak Encryption**

```bash
# Extract file signature
echo 'base64_encoded_token' | base64 -d | xxd -p | head -n 4
```

Use **CyberChef** to analyze token encoding:  
ðŸ”— [CyberChef](https://gchq.github.io/CyberChef/)

---

## **4. API Rate-Limiting Bypass**

APIs enforce **rate limits** to prevent brute-force attacks, but attackers use **IP rotation & header tampering** to bypass them.

|**Bypass Method**|**Description**|**Mitigation**|
|---|---|---|
|**IP Rotation**|Changing IPs circumvents rate limits|Enforce **user-based rate limiting**|
|**X-Forwarded-For Spoofing**|Spoofing XFF header bypasses IP-based blocking|Only trust **proxy-set headers**|
|**Session-Based Brute Force**|Using different sessions to reset limits|Monitor **failed attempts per user**|

#### **Example 4: Brute Force Username via API**

```bash
wfuzz -c -z file,top-usernames.txt -d "username=FUZZ&password=test123" --hs "Invalid" http://api.target.com/login
```

#### **Bypassing Rate-Limiting**

```bash
curl -H "X-Forwarded-For: 127.0.0.1" http://api.target.com
```

---

## **5. Microservices Pivoting & Service-to-Service Security**

Microservices are vulnerable to **lateral movement**, where an attacker **compromises one service** and pivots to others.

|**Attack**|**Description**|**Mitigation**|
|---|---|---|
|**Microservices Pivoting**|Exploiting one microservice to attack others|Enforce **zero-trust policies, IAM roles**|
|**Unrestricted API Calls**|Internal APIs are exposed externally|Use **API gateways & allow-listing**|
|**mTLS Spoofing**|Bypassing mutual TLS authentication|Use **certificate pinning & validation**|

#### **Securing Service-to-Service Communication**

```bash
# Enforce mutual TLS
openssl req -new -x509 -days 365 -nodes -out server.pem -keyout server.key
```

---

## **6. API Enumeration & Credential Stuffing**

APIs are often vulnerable to **credential stuffing**, where attackers use leaked credentials to gain access.

|**Attack**|**Description**|**Mitigation**|
|---|---|---|
|**Username Enumeration**|API error messages reveal valid usernames|Use **generic login failure messages**|
|**Credential Stuffing**|Testing known credentials on multiple services|Enable **MFA, anomaly detection**|
|**Brute Force Tokens**|Guessing authentication tokens via automation|Implement **account lockouts**|

#### **Example 5: Enumerate Usernames via API**

```bash
wfuzz -c -z file,usernames.txt -d "username=FUZZ&password=dummy" --hs "Invalid" http://target.com/api/auth
```

---

## **7. Weak Cryptography in API Tokens**

Attackers exploit weak cryptographic functions used for hashing, signing JWTs, or storing credentials.

|**Weak Crypto Method**|**Risk**|**Mitigation**|
|---|---|---|
|**MD5/SHA-1 Hashing**|Weak algorithms can be cracked easily|Use **bcrypt, PBKDF2, Argon2**|
|**Predictable PRNG**|Non-secure random session tokens|Use **CSPRNG for token generation**|
|**Hardcoded Secrets**|Secrets stored in source code|Store **secrets in vaults (AWS Secrets Manager, HashiCorp Vault)**|

#### **Example 6: Benchmarking Hashing Algorithms**

```python
import hashlib, time

start = time.time()
for _ in range(10000): hashlib.sha1(b'password').hexdigest()
print("SHA-1 Time:", time.time() - start)

start = time.time()
for _ in range(10000): hashlib.pbkdf2_hmac('sha256', b'password', b'salt', 100000)
print("PBKDF2 Time:", time.time() - start)
```

---

## **8. Microservices Security Best Practices**

|**Security Measure**|**Implementation**|**Benefits**|
|---|---|---|
|**API Gateway Security**|Enforce **rate limits, logging, and access control**|Protects against **abuse & API enumeration**|
|**JWT Security**|Use **short expiration, signed tokens**|Prevents **token theft & replay attacks**|
|**Mutual TLS (mTLS)**|Encrypts **service-to-service communication**|Prevents **spoofing & MITM attacks**|
|**IAM Policies**|Restrict **API access per role/service**|Minimizes **privilege escalation risks**|
|**Secure Logging**|Monitor **API access patterns for anomalies**|Detects **credential stuffing & brute force**|
